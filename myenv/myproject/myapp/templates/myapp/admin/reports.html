{% extends 'myapp/admin/base.html' %}
{% load static %}
{% block title %}Reports & Analytics{% endblock %}
{% block content %}

<div class="d-flex align-items-center mb-4">
    <h2 class="fw-bold text-dark mb-1">Reports & Analytics</h2>
    <button class="btn btn-sm btn-outline-primary ms-3" id="refresh-reports-btn" onclick="refreshReports()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
    <small class="text-muted ms-3">Last updated: <span id="reports-last-updated">Just now</span></small>
</div>
<div class="row g-3 my-2">
    <div class="col-md-3">
        <div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
            <div>
                <h3 class="fs-2" id="report-total-revenue">₹{{ total_revenue|floatformat:2 }}</h3>
                <p class="fs-5">Total Revenue</p>
            </div>
            <i class="fas fa-rupee-sign fs-1 primary-text border rounded-full secondary-bg p-3"></i>
        </div>
    </div>
    <div class="col-md-3">
        <div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
            <div>
                <h3 class="fs-2" id="report-total-patients">{{ total_patients }}</h3>
                <p class="fs-5">Total Patients</p>
            </div>
            <i class="fas fa-users fs-1 primary-text border rounded-full secondary-bg p-3"></i>
        </div>
    </div>
    <div class="col-md-3">
        <div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
            <div>
                <h3 class="fs-2" id="report-total-appointments">{{ total_appointments }}</h3>
                <p class="fs-5">Appointments</p>
            </div>
            <i class="fas fa-calendar-check fs-1 primary-text border rounded-full secondary-bg p-3"></i>
        </div>
    </div>
    <div class="col-md-3">
        <div class="p-3 bg-white shadow-sm d-flex justify-content-around align-items-center rounded">
            <div>
                <h3 class="fs-2" id="report-satisfaction-rate">{{ satisfaction_rate }}%</h3>
                <p class="fs-5">Satisfaction</p>
            </div>
            <i class="fas fa-smile fs-1 primary-text border rounded-full secondary-bg p-3"></i>
        </div>
    </div>
</div>
<div class="row my-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Monthly Performance</h5>
                <div class="chart-placeholder bg-light p-5 text-center rounded">
                    <i class="fas fa-chart-bar fa-3x text-muted"></i>
                    <p class="mt-3 text-muted">Chart Placeholder - Revenue & Patient Trends</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Department Distribution</h5>
                <div class="chart-placeholder bg-light p-5 text-center rounded">
                    <i class="fas fa-chart-pie fa-3x text-muted"></i>
                    <p class="mt-3 text-muted">Chart Placeholder - Appointments by Department</p>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3">Quick Access Reports</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'financial_report_pdf' %}" class="btn btn-outline-primary w-100"
                            target="_blank">
                            <i class="fas fa-file-pdf me-2"></i>Financial Report
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'patient_records_excel' %}" class="btn btn-outline-success w-100">
                            <i class="fas fa-file-excel me-2"></i>Patient Records
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{% url 'staff_performance_csv' %}" class="btn btn-outline-info w-100">
                            <i class="fas fa-file-csv me-2"></i>Staff Performance
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // Real-time reports page update functionality
    let reportsRefreshInterval;
    const REPORTS_REFRESH_INTERVAL = 30000; // 30 seconds

    function refreshReports() {
        const refreshBtn = document.getElementById('refresh-reports-btn');
        const icon = refreshBtn.querySelector('i');
        icon.classList.add('fa-spin');
        refreshBtn.disabled = true;

        fetch('/api/admin/reports-stats/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('report-total-revenue').textContent = '₹' + data.stats.total_revenue.toFixed(2);
                document.getElementById('report-total-patients').textContent = data.stats.total_patients;
                document.getElementById('report-total-appointments').textContent = data.stats.total_appointments;
                document.getElementById('report-satisfaction-rate').textContent = data.stats.satisfaction_rate + '%';
                updateReportsTimestamp(data.timestamp);
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            });
    }

    function updateReportsTimestamp(timestamp) {
        const now = new Date();
        const updated = new Date(timestamp);
        const diff = Math.floor((now - updated) / 1000);
        let timeText = 'Just now';
        if (diff > 60) {
            const minutes = Math.floor(diff / 60);
            timeText = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        }
        document.getElementById('reports-last-updated').textContent = timeText;
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateReportsTimestamp(new Date().toISOString());
        reportsRefreshInterval = setInterval(refreshReports, REPORTS_REFRESH_INTERVAL);
        console.log('Reports auto-refresh enabled (every 30 seconds)');
    });

    window.addEventListener('beforeunload', function () {
        if (reportsRefreshInterval) clearInterval(reportsRefreshInterval);
    });
</script>
{% endblock %}